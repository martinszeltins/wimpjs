<!DOCTYPE html>
<html>
    <head>
        <title>WIMP - Framebuffer Effects Demo</title>

        <style>
            body {
                margin: 0;
                padding: 20px;
                background: #999;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                gap: 20px;
            }
            canvas {
                display: block;
                background: white;
                border: 2px solid black;
                cursor: none;
            }
            .label {
                color: white;
                font-family: monospace;
                font-size: 18px;
                margin-bottom: -10px;
            }
            .controls {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }
            button {
                padding: 8px 16px;
                font-family: monospace;
                font-size: 14px;
                background: white;
                border: 2px solid black;
                cursor: pointer;
            }
            button.active {
                background: black;
                color: white;
            }
            button:hover {
                background: #ddd;
            }
            button.active:hover {
                background: #333;
            }
            #pip {
                position: fixed;
                bottom: 30px;
                right: 30px;
                border: 3px solid white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                display: none;
                cursor: pointer;
            }
            #pip.active {
                display: block;
            }
            #magnifier {
                position: fixed;
                width: 200px;
                height: 200px;
                border: 3px solid white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
                pointer-events: none;
                display: none;
                border-radius: 50%;
                overflow: hidden;
            }
            #magnifier.active {
                display: block;
            }
        </style>
    </head>

    <body>
        <div class="label">Display 1 (Interactive)</div>
        <canvas id="screen1" width="1280" height="720"></canvas>
        
        <div class="controls">
            <button id="btnEffect">Effect: None</button>
            <button id="btnMagnifier">Magnifier: OFF</button>
            <button id="btnPip">Picture-in-Picture: OFF</button>
        </div>
        
        <div class="label">Display 2 (With Effects)</div>
        <canvas id="screen2" width="1280" height="720"></canvas>
        
        <canvas id="pip" width="320" height="180"></canvas>
        <div id="magnifier">
            <canvas id="magnifierCanvas" width="200" height="200"></canvas>
        </div>
        
        <script src="server.js"></script>
        <script src="client.js"></script>
        <script>
            const canvas1 = document.getElementById('screen1')
            const canvasCtx1 = canvas1.getContext('2d')
            
            const canvas2 = document.getElementById('screen2')
            const canvasCtx2 = canvas2.getContext('2d')
            
            const pipCanvas = document.getElementById('pip')
            const pipCtx = pipCanvas.getContext('2d')
            
            const magnifierCanvas = document.getElementById('magnifierCanvas')
            const magnifierCtx = magnifierCanvas.getContext('2d')
            const magnifierDiv = document.getElementById('magnifier')

            const server = WIMPServer()
            const client = WIMPClient(server)
            
            let currentEffect = 0
            const effects = ['None', 'Grayscale', 'Sepia', 'CRT Scanlines', 'Pixelated']
            let magnifierEnabled = false
            let pipEnabled = false
            let mousePageX = 0
            let mousePageY = 0

            const btnEffect = document.getElementById('btnEffect')
            const btnMagnifier = document.getElementById('btnMagnifier')
            const btnPip = document.getElementById('btnPip')
            
            btnEffect.addEventListener('click', () => {
                currentEffect = (currentEffect + 1) % effects.length
                btnEffect.textContent = 'Effect: ' + effects[currentEffect]
            })
            
            btnMagnifier.addEventListener('click', () => {
                magnifierEnabled = !magnifierEnabled
                btnMagnifier.textContent = 'Magnifier: ' + (magnifierEnabled ? 'ON' : 'OFF')
                btnMagnifier.classList.toggle('active', magnifierEnabled)
                magnifierDiv.classList.toggle('active', magnifierEnabled)
            })
            
            btnPip.addEventListener('click', () => {
                pipEnabled = !pipEnabled
                btnPip.textContent = 'Picture-in-Picture: ' + (pipEnabled ? 'ON' : 'OFF')
                btnPip.classList.toggle('active', pipEnabled)
                pipCanvas.classList.toggle('active', pipEnabled)
            })

            document.addEventListener('mousemove', (event) => {
                mousePageX = event.pageX
                mousePageY = event.pageY
                
                if (magnifierEnabled) {
                    magnifierDiv.style.left = (mousePageX + 20) + 'px'
                    magnifierDiv.style.top = (mousePageY + 20) + 'px'
                }
            })

            canvas1.addEventListener('mousemove', (event) => {
                const rect = canvas1.getBoundingClientRect()
                const x = event.clientX - rect.left
                const y = event.clientY - rect.top
                server.handleMouseMove(x, y)
            })

            canvas1.addEventListener('mouseenter', (event) => {
                const rect = canvas1.getBoundingClientRect()
                const x = event.clientX - rect.left
                const y = event.clientY - rect.top
                server.handleMouseMove(x, y)
            })

            canvas1.addEventListener('mousedown', (event) => {
                const rect = canvas1.getBoundingClientRect()
                const x = event.clientX - rect.left
                const y = event.clientY - rect.top
                server.handleMouseDown(x, y, typeof getDockItemAtPosition !== 'undefined' ? getDockItemAtPosition : null)
            })

            canvas1.addEventListener('mouseup', () => {
                server.handleMouseUp()
            })
            
            pipCanvas.addEventListener('mousemove', (event) => {
                if (!pipEnabled) return
                const rect = pipCanvas.getBoundingClientRect()
                const pipX = event.clientX - rect.left
                const pipY = event.clientY - rect.top
                const x = (pipX / 320) * 1280
                const y = (pipY / 180) * 720
                server.handleMouseMove(x, y)
            })
            
            pipCanvas.addEventListener('mousedown', (event) => {
                if (!pipEnabled) return
                const rect = pipCanvas.getBoundingClientRect()
                const pipX = event.clientX - rect.left
                const pipY = event.clientY - rect.top
                const x = (pipX / 320) * 1280
                const y = (pipY / 180) * 720
                server.handleMouseDown(x, y, typeof getDockItemAtPosition !== 'undefined' ? getDockItemAtPosition : null)
            })
            
            pipCanvas.addEventListener('mouseup', () => {
                if (!pipEnabled) return
                server.handleMouseUp()
            })
            
            const applyEffect = (imageData) => {
                const data = imageData.data
                
                if (currentEffect === 1) {
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114
                        data[i] = data[i + 1] = data[i + 2] = gray
                    }
                } else if (currentEffect === 2) {
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i + 1], b = data[i + 2]
                        data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189)
                        data[i + 1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168)
                        data[i + 2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131)
                    }
                } else if (currentEffect === 3) {
                    for (let y = 0; y < 720; y += 2) {
                        for (let x = 0; x < 1280; x++) {
                            const i = (y * 1280 + x) * 4
                            data[i] *= 0.7
                            data[i + 1] *= 0.7
                            data[i + 2] *= 0.7
                        }
                    }
                } else if (currentEffect === 4) {
                    const pixelSize = 4
                    for (let y = 0; y < 720; y += pixelSize) {
                        for (let x = 0; x < 1280; x += pixelSize) {
                            const i = (y * 1280 + x) * 4
                            const r = data[i], g = data[i + 1], b = data[i + 2]
                            
                            for (let py = 0; py < pixelSize && y + py < 720; py++) {
                                for (let px = 0; px < pixelSize && x + px < 1280; px++) {
                                    const pi = ((y + py) * 1280 + (x + px)) * 4
                                    data[pi] = r
                                    data[pi + 1] = g
                                    data[pi + 2] = b
                                }
                            }
                        }
                    }
                }
                
                return imageData
            }

            const render = () => {
                server.composite()
                
                const framebuffer = server.getFramebuffer()
                
                const imageData1 = canvasCtx1.createImageData(server.width, server.height)
                imageData1.data.set(framebuffer)
                canvasCtx1.putImageData(imageData1, 0, 0)
                
                const imageData2 = canvasCtx2.createImageData(server.width, server.height)
                imageData2.data.set(framebuffer)
                applyEffect(imageData2)
                canvasCtx2.putImageData(imageData2, 0, 0)
                
                if (pipEnabled) {
                    pipCtx.drawImage(canvas1, 0, 0, 1280, 720, 0, 0, 320, 180)
                }
                
                if (magnifierEnabled) {
                    const mousePos = server.getMousePosition()
                    const zoomLevel = 3
                    const sourceSize = 200 / zoomLevel
                    const sx = Math.max(0, Math.min(1280 - sourceSize, mousePos.x - sourceSize / 2))
                    const sy = Math.max(0, Math.min(720 - sourceSize, mousePos.y - sourceSize / 2))
                    
                    magnifierCtx.drawImage(canvas1, sx, sy, sourceSize, sourceSize, 0, 0, 200, 200)
                }

                requestAnimationFrame(render)
            }

            render()
        </script>
        <script src="topbar.js"></script>
        <script src="app1.js"></script>
        <script src="app2.js"></script>
        <script src="dock.js"></script>
    </body>
</html>
